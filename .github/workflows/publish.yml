name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'

jobs:
  # Run existing CI checks first
  lint:
    uses: ./.github/workflows/lint.yml

  test:
    uses: ./.github/workflows/test.yml

  # Build and publish to PyPI
  publish:
    name: Publish to PyPI
    environment: pypi
    needs: [lint, test]
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for trusted publishing
      contents: read

    steps:
    # Check out the repository code
    - uses: actions/checkout@v4

    # Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    # Install Poetry for building the package
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    # Extract version from tag (remove 'v' prefix and any suffix like '-test')
    - name: Extract version from tag
      id: tag_version
      run: |
        TAG=${GITHUB_REF#refs/tags/v}
        # Remove any suffix after hyphen (e.g., '0.1.0-test' -> '0.1.0')
        VERSION=${TAG%%-*}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    # Read version from pyproject.toml
    - name: Get version from pyproject.toml
      id: pyproject_version
      run: |
        VERSION=$(poetry version -s)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    # Validate that tag matches pyproject.toml version
    - name: Validate version consistency
      run: |
        if [ "${{ steps.tag_version.outputs.version }}" != "${{ steps.pyproject_version.outputs.version }}" ]; then
          echo "ERROR: Version mismatch!"
          echo "  Git tag version: ${{ steps.tag_version.outputs.version }}"
          echo "  pyproject.toml version: ${{ steps.pyproject_version.outputs.version }}"
          echo ""
          echo "Please ensure the git tag matches the version in pyproject.toml"
          exit 1
        fi
        echo "âœ“ Version validation passed: ${{ steps.pyproject_version.outputs.version }}"

    # Build the package for publication
    - name: Build package
      run: poetry build

    # Publish to PyPI using trusted publishing
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
